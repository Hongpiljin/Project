<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rental.mapper.ChatMapper">
  
  <!-- 채팅방 생성: 새로운 채팅방 정보를 DB에 삽입 -->
  <insert id="insertChatRoom" parameterType="com.rental.dto.ChatRoomDTO">
    INSERT INTO chat_room (room_id, user_no, admin_no, status, created_at)
    VALUES (#{roomId}, #{userNo}, #{adminNo, jdbcType=INTEGER}, #{status}, #{createdAt})
  </insert>

  <!-- 채팅방 종료: 채팅방 상태를 'closed'로 변경하고 종료 시간을 기록 -->
  <update id="updateRoomStatusToClosed">
    UPDATE chat_room
    SET status = 'closed',
        closed_at = #{closedAt}
    WHERE room_id = #{roomId}
  </update>

  <!-- 채팅방 수락: 상담원이 배정되면서 채팅방 상태를 'active'로 변경 -->
<update id="updateRoomStatusToActive" parameterType="map">
    UPDATE CHAT_ROOM
    SET 
        admin_no = #{consultantId},
        admin_name = #{adminName},
        status = 'active',
        accepted_at = #{acceptedAt}
    WHERE room_id = #{roomId}
</update>
  
  <!-- 채팅방 거절: 채팅방 상태를 'rejected'로 변경하며 종료 시간을 기록 -->
  <update id="updateRoomStatusToRejected">
    UPDATE chat_room
    SET status = 'rejected',
        closed_at = #{rejectedAt}
    WHERE room_id = #{roomId}
  </update>

  <!-- 채팅 메시지 저장: 전달받은 메시지를 CHAT_MESSAGE 테이블에 삽입 -->
 <insert id="insertChatMessage" parameterType="com.rental.dto.ChatMessageDTO">
  INSERT INTO CHAT_MESSAGE (message_id, room_id, sender_id, message, sent_at)
  VALUES (CHAT_MESSAGE_SEQ.NEXTVAL, #{roomId}, #{senderId}, #{message}, #{sentAt})
</insert>
  
<!--  상담원 리스트 : adminName , status 필터링 -->
<select id="selectChatRooms" resultType="com.rental.dto.ChatRoomDTO">
  SELECT room_id, user_no, admin_no, status, created_at, closed_at, admin_name
  FROM chat_room
  <where>
    <if test="adminName != null and adminName != ''">
      admin_name LIKE '%' || #{adminName} || '%'
    </if>
    <if test="status != null and status != ''">
      <if test="adminName != null and adminName != ''">AND</if>
      status = #{status}
    </if>
  </where>
  ORDER BY created_at DESC
</select>


</mapper>