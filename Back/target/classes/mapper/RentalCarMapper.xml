<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rental.mapper.RentalCarMapper">

    <!-- âœ… 1ï¸âƒ£ ëª¨ë“  ë ŒíŠ¸ì¹´ ì¡°íšŒ -->
    <select id="findAllRentalCars" resultType="com.rental.dto.RentalCarDTO">
        SELECT RENTAL_CAR_NO, MODEL, TYPE, LOCATION, FUEL, TRANSMISSION, PRICE_PER_DAY, HOURLY_PRICE, STATUS
        FROM RENTAL_CAR
    </select>

    <!-- âœ… 2ï¸âƒ£ íŠ¹ì • ë ŒíŠ¸ì¹´ ë²ˆí˜¸ë¡œ ì¡°íšŒ -->
    <select id="findRentalCarById" parameterType="String" resultType="com.rental.dto.RentalCarDTO">
        SELECT RENTAL_CAR_NO, MODEL, TYPE, LOCATION, FUEL, TRANSMISSION, PRICE_PER_DAY, HOURLY_PRICE, INSURANCE_FEE
        FROM RENTAL_CAR 
        WHERE RENTAL_CAR_NO = #{rentalCarNo}
    </select>

    <!-- âœ… 3ï¸âƒ£ ì‚¬ìš©ìž ë²ˆí˜¸ ì¡°íšŒ (userId â†’ userNo) -->
    <select id="getUserNoByUserId" parameterType="String" resultType="int">
        SELECT user_no FROM USERS WHERE user_id = #{userId}
    </select>

    <!-- âœ… 4ï¸âƒ£ ë ŒíŠ¸ì¹´ ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ -->
    <select id="checkCarAvailability" parameterType="map" resultType="boolean">
        SELECT COUNT(*) = 0
        FROM RENTAL_RESERVATION
        WHERE RENTAL_CAR_NO = #{rentalCarNo}
          AND (START_DATE BETWEEN #{startDate} AND #{endDate}
               OR END_DATE BETWEEN #{startDate} AND #{endDate})
    </select>

    <!-- âœ… 5ï¸âƒ£ ë ŒíŠ¸ì¹´ ì˜ˆì•½ ì •ë³´ ì €ìž¥ -->
    <insert id="insertReservation" parameterType="com.rental.dto.RentalReservationDTO">
        INSERT INTO RENTAL_RESERVATION 
        (RESERVATION_ID, RENTAL_CAR_NO, USER_ID, START_DATE, END_DATE, TOTAL_DAYS, TOTAL_HOURS, TOTAL_PRICE, INSURANCE_INCLUDED, PAYMENT_METHOD, STATUS)
        VALUES 
        (RENTAL_RESERVATION_SEQ.NEXTVAL, #{rentalCarNo}, #{userId}, #{startDate}, #{endDate}, #{totalDays}, #{totalHours}, #{totalPrice}, #{insuranceIncluded}, #{paymentMethod}, #{status})
    </insert>

    <!-- âœ… 6ï¸âƒ£ ê°€ìž¥ ìµœê·¼ ì˜ˆì•½ ID ê°€ì ¸ì˜¤ê¸° -->
    <select id="getLatestReservationId" resultType="Long">
        SELECT MAX(RESERVATION_ID) FROM RENTAL_RESERVATION
    </select>

    <!-- âœ… 7ï¸âƒ£ ì‚¬ìš©ìž í¬ì¸íŠ¸ ì¡°íšŒ -->
    <select id="getUserPoint" parameterType="int" resultType="int">
        SELECT POINT FROM USERS WHERE user_no = #{userNo}
    </select>

    <!-- âœ… 8ï¸âƒ£ ì‚¬ìš©ìž í¬ì¸íŠ¸ ì°¨ê° -->
    <update id="updateUserPoint">
        UPDATE USERS SET POINT = POINT - #{totalPrice} WHERE user_no = #{userNo}
    </update>

    <!-- âœ… 9ï¸âƒ£ ë ŒíŠ¸ì¹´ ê²°ì œ ì •ë³´ ì €ìž¥ -->
    <insert id="insertRentalPayment" parameterType="com.rental.dto.RentalPaymentDTO">
        INSERT INTO RENTAL_PAYMENT (
            PAYMENT_ID, USER_ID, RESERVATION_ID, TOTAL_PRICE, PAYMENT_METHOD, PAYMENT_DATE
        ) VALUES (
            RENTAL_PAYMENT_SEQ.NEXTVAL,
            #{rentalPaymentDTO.userId},
            #{rentalPaymentDTO.reservationId},
            #{rentalPaymentDTO.totalPrice},
            #{rentalPaymentDTO.paymentMethod}, SYSDATE
        )
    </insert>

    <!-- âœ… ðŸ”Ÿ ë§ˆì§€ë§‰ ê²°ì œ ID ì¡°íšŒ -->
    <select id="getLatestPaymentId" resultType="long">
        SELECT MAX(PAYMENT_ID) FROM RENTAL_PAYMENT
    </select>

    <!-- âœ… 1ï¸âƒ£1ï¸âƒ£ ì‚¬ìš©ìž ì •ë³´ ì¡°íšŒ -->
    <select id="getUserInfo" parameterType="int" resultType="map">
        SELECT user_no, user_id, name, email, phone, point
        FROM USERS
        WHERE user_no = #{userNo}
    </select>
    
    

</mapper>
