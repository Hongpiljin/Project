<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rental.mapper.ChatMapper">
  
  <!-- 채팅방 생성: 새로운 채팅방 정보를 DB에 삽입 -->
  <insert id="insertChatRoom" parameterType="com.rental.dto.ChatRoomDTO">
    INSERT INTO chat_room (room_id, user_no, admin_no, status, created_at)
    VALUES (#{roomId}, #{userNo}, #{adminNo, jdbcType=INTEGER}, #{status}, #{createdAt})
  </insert>

  <!-- 채팅방 종료: 채팅방 상태를 'closed'로 변경하고 종료 시간을 기록 -->
  <update id="updateRoomStatusToClosed">
    UPDATE chat_room
    SET status = 'closed',
        closed_at = #{closedAt}
    WHERE room_id = #{roomId}
  </update>

  <!-- 채팅방 목록 조회: 선택된 상태에 따라 채팅방 목록을 반환 -->
  <select id="selectChatRooms" parameterType="string" resultType="com.rental.dto.ChatRoomDTO">
    SELECT room_id, user_no, admin_no, status, created_at, closed_at
    FROM chat_room
    <if test="status != null and status != ''">
      WHERE status = #{status}
    </if>
  </select>

  <!-- 채팅방 수락: 상담원이 배정되면서 채팅방 상태를 'active'로 변경 -->
  <update id="updateRoomStatusToActive">
    UPDATE chat_room
    SET status = 'active',
        admin_no = #{consultantId, jdbcType=INTEGER},
        accepted_at = #{acceptedAt}
    WHERE room_id = #{roomId}
  </update>
  
  <!-- 채팅방 거절: 채팅방 상태를 'rejected'로 변경하며 종료 시간을 기록 -->
  <update id="updateRoomStatusToRejected">
    UPDATE chat_room
    SET status = 'rejected',
        closed_at = #{rejectedAt}
    WHERE room_id = #{roomId}
  </update>

  <!-- 채팅 메시지 저장: 전달받은 메시지를 CHAT_MESSAGE 테이블에 삽입 -->
 <insert id="insertChatMessage" parameterType="com.rental.dto.ChatMessageDTO">
  INSERT INTO CHAT_MESSAGE (message_id, room_id, sender_id, message, sent_at)
  VALUES (CHAT_MESSAGE_SEQ.NEXTVAL, #{roomId}, #{senderId}, #{message}, #{sentAt})
</insert>
  
</mapper>